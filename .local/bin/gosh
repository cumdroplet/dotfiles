#!/bin/sh

# Simple GOG game launcher
#
# todo..
# pull playtimes from gog galexy
# submit playtimes and achivements (hard)

GAMES_DIR="$XDG_DATA_HOME/GOG Games"
LOG_FILE="$XDG_CACHE_HOME/GOG_time.json"

mkdir -p "$XDG_CACHE_HOME"

if [ ! -s "$LOG_FILE" ]; then
	echo "{}" > "$LOG_FILE"
fi

launch() {
	GAME_NAME="$1"
	START_TIME=$(date +%s)

	if [ -z "$GAME_NAME" ]; then
		echo "Error: No game name provided!" >&2
		exit 1
	fi

	if [ ! -d "$GAMES_DIR/$GAME_NAME" ]; then
		echo "Error: '$GAME_NAME' not found!" >&2
		exit 1
	fi

	echo "Tracking: $GAME_NAME"
	"$GAMES_DIR/$GAME_NAME/start.sh"

	END_TIME=$(date +%s)
	PLAYTIME=$((END_TIME - START_TIME))

	jq --arg game "$GAME_NAME" --argjson time "$PLAYTIME" \
	   'if has($game) then .[$game] += $time else .[$game] = $time end' \
	   "$LOG_FILE" > "$LOG_FILE.tmp" && mv "$LOG_FILE.tmp" "$LOG_FILE"

	echo "Game: $GAME_NAME | Time Played: $PLAYTIME seconds"
}

if [ "$#" -eq 0 ]; then
	GAME=$(ls "$GAMES_DIR" | dmenu -i -p "Select game:")

	if [ -z "$GAME" ]; then
		echo "No game selected." >&2
		exit 1
	fi

	launch "$GAME"
else
	launch "$1"
fi
